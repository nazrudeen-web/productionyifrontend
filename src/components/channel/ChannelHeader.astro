---
const { data } = Astro.props;
import Share from "../Share.astro";

const publishedDate = new Date(data.publishedAt).toLocaleDateString("en-US", {
  year: "numeric",
  month: "short",
  day: "numeric",
});

const topics =
  data.topicCategories?.map((url) => {
    const name = url.split("/").pop()?.replace(/_/g, " ") || "";
    return decodeURIComponent(name);
  }) || [];

const readableTopics =
  topics.length > 1
    ? topics.slice(0, -1).join(", ") + " & " + topics.slice(-1)
    : topics[0] || "Creator";

const countryFull = data.country || "US";
// Convert country code to full name
const countryName = new Intl.DisplayNames(["en"], { type: "region" }).of(
  countryFull
);

// Convert country code to flag emoji
function getFlagEmoji(code) {
  return code
    .toUpperCase()
    .replace(/./g, (char) => String.fromCodePoint(127397 + char.charCodeAt()));
}
const flag = getFlagEmoji(countryFull);
---

<!-- 1. Title, About, Country, Category -->
<section
  class="mx-auto mt-10 max-w-4xl overflow-hidden bg-white shadow-lg md:rounded-xl"
>
  <!-- Banner with fallback + profile image properly aligned -->
  <div
    class="relative h-36 w-full rounded-t-xl bg-gradient-to-br from-gray-600 to-gray-700"
  >
    <!-- Banner image (with fallback if no URL) -->
    {
      data.bannerImage ? (
        <img
          src={data.bannerImage}
           alt={`Banner image of ${data.title}`}
          class="h-full w-full object-cover"
          loading="lazy"
          decoding="async"
          onerror="console.error('Banner image failed to load:', event); this.style.display = 'none';"
        />
      ) : null
    }

    <!-- Profile image (correct position + spacing) -->
    <div class="absolute -bottom-16 left-6 z-10">
      <img
        src={data.thumbnail}
        alt={`Profile picture of ${data.title}`}
        width="128"
        height="128"
        class="h-32 w-32 rounded-full border-4 border-white shadow-md object-cover aspect-square bg-white"
        decoding="async"
        onerror="console.error('profile image failed to load:', event); this.style.display = 'none';"
      />
    </div>
  </div>

  <!-- Header Info -->
  <div class="px-6 pt-20 pb-6">
    <div class="flex flex-wrap items-start justify-between">
      <div>
        <h2 class="text-2xl font-bold">{data.title}</h2>
        <p class="text-sm text-gray-500 md:text-base">
          YouTube Creator · {readableTopics}
        </p>
        <div class="mt-1 text-sm text-gray-500">
          Published: {publishedDate} · {flag}
          {countryName}
        </div>
      </div>

      <!-- Action Section -->
      <div class="flex flex-wrap items-center justify-between gap-4 mt-4">
        <!-- Visit Channel Button -->
        <a
          href={`https://www.youtube.com/${data.handle}`}
          target="_blank"
          rel="noopener"
          class="flex items-center gap-2 rounded-md bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-700"
        >
          <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M10 3v2h8.59L3 20.59 4.41 22 20 6.41V15h2V3z"></path>
          </svg>
          Visit Channel
        </a>

        <!-- Share Icons Group -->
        <Share data={data} />
      </div>
    </div>
  </div>
</section>
