---
const { params } = Astro;

import BaseLayout from "../layout/BaseLayout.astro";
import NotFound from "./not-found.astro";
import ChannelDetails from "../components/ChannelDetails.astro";
import HeaderWithForm from "../components/HeaderWithForm.astro";
import Footer from "../components/Footer.astro";

const cleanName = (params.name ?? "").replace(/-net-worth$/, "");
const apiUrl = `https://api.youtubersincome.com/?channel=@${cleanName}`;

/** @type {any} */
let data = null;
let isError = false;

try {
  const response = await fetch(apiUrl);
  data = await response.json();
  // Check for required fields to validate real channel data
  // @ts-ignore
  if (!data || !data.title || !data.subscriberCount || !data.viewCount) {
    isError = true;
  }
} catch (err) {
  console.error("Failed to fetch channel data:", err);
  isError = true;
}

// @ts-ignore
const channelTitle = data?.title ?? "Unknown Channel";

// @ts-ignore
const pageTitle = `How Much Does ${channelTitle} Make on YouTube?`;
// @ts-ignore
const pageDescription = `Find out how much ${channelTitle} earns from YouTube ads. Includes daily, monthly & yearly income, net worth, views, and subscriber stats.`;
const pageUrl = `https://youtubersincome.com/${params.name}`;
// @ts-ignore
const pageImage = data?.thumbnail ?? null;
---

<BaseLayout
  pageTitle={pageTitle}
  pageDescription={pageDescription}
  pageUrl={pageUrl}
  pageImage={pageImage}
>
  <HeaderWithForm />
  {isError ? <NotFound /> : <ChannelDetails data={data} />}
  <Footer />
</BaseLayout>
