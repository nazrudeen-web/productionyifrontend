---
const { params } = Astro;

import BaseLayout from "../layout/BaseLayout.astro";
import NotFound from "../components/NotFound.astro"; // make sure this exists
import ChannelDetails from "../components/ChannelDetails.astro";
import HeaderWithForm from "../components/HeaderWithForm.astro";
import HeaderReact from "../components/HeaderReact.jsx";
import FooterReact from '../components/FooterReact.jsx';

import Footer from "../components/Footer.astro";

const cleanName = (params.name ?? "").replace(/-net-worth$/, "");
const apiUrl = `https://api.youtubersincome.com/?channel=@${cleanName}`;

let data = null;
let isError = false;

try {
  const response = await fetch(apiUrl);
  data = await response.json();
  if (!data || !data.title || !data.subscriberCount || !data.viewCount) {
    isError = true;
  }
} catch (err) {
  console.error("API error:", err);
  isError = true;
}

// âœ… Set status manually for SEO and crawlers
if (isError) {
  Astro.response.status = 404;
}

const year = new Date().getFullYear();
const siteName = "youtubersincome.com";
const formattedIncome = (num) => {
  if (num >= 1e9) return `$${(num / 1e9).toFixed(1)} billion`;
  if (num >= 1e6) return `$${(num / 1e6).toFixed(1)} million`;
  return `$${num}`;
};

const channelTitle = data?.title ?? "Unknown Channel";
const pageTitle = `${channelTitle} Net Worth ${year}: How ${formattedIncome(data.yearlyIncome)} Was Built`;
const pageDescription = `${channelTitle} earns ${formattedIncome(data.monthlyIncome)}/month from YouTube, sponsorships, and business ventures. See full net worth breakdown, income sources, and growth over time.`;
const pageUrl = `https://youtubersincome.com/${params.name}`;
const pageImage = data?.thumbnail ?? null;
---

<BaseLayout
  pageTitle={pageTitle}
  pageDescription={pageDescription}
  pageUrl={pageUrl}
  pageImage={pageImage}
>
  <HeaderReact client:only="react" /> 

  <main class="max-w-5xl mx-auto min-h-screen ">
    <div class="px-4 py-6 md:py-8">
  {isError ? (
    <NotFound />
  ) : (
    <ChannelDetails data={data} />
  )}

</div>


</main>
<FooterReact/>
</BaseLayout>
