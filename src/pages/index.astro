---
import "../styles/global.css";
import BaseLayout from "../layout/BaseLayout.astro";
import Header from "../components/Header.jsx";
import Footer from "@/components/Footer.astro";
import Hero from "@/components/index-page/Hero.astro";
import RecentChannels from "@/components/index-page/RecentChannels.astro";
import HighestEarningChannels from "@/components/index-page/HighestEarningChannels.astro";
import BlogPreview from "@/components/index-page/BlogPreview.astro";
import HowItWorks from "@/components/index-page/HowItWorks.astro";
import Faq from "../components/index-page/Faq.jsx";
import About from "@/components/index-page/About.astro";

// Get "channel" input from URL (example: ?channel=MrBeast or ?channel=@mrbeast)
const url = new URL(Astro.request.url);
const pathname = url.pathname;

// Only run redirect logic if user is on homepage AND ?channel exists
const input = pathname === "/" ? url.searchParams.get("channel") : null;

// Clean user input: remove @ or get path from full URL
function cleanInput(raw) {
  const trimmed = raw.trim();
  if (trimmed.startsWith("http")) {
    try {
      const link = new URL(trimmed);
      return link.pathname.replace(/^\/+/, "");
    } catch {
      return trimmed;
    }
  }
  return trimmed.replace(/^@+/, "");
}

// If input exists, process it and redirect to proper page
if (input) {
  const cleaned = cleanInput(input);
  const apiUrl = `https://api.youtubersincome.com/?channel=${encodeURIComponent(cleaned)}`;
  const res = await fetch(apiUrl);
  const data = await res.json();

  if (res.ok && (data.handle || data.title)) {
    const baseName = data.handle
      ? data.handle.replace(/^@+/, "")
      : data.title.toLowerCase().replace(/\s+/g, "");
    return Astro.redirect(`/${baseName}-net-worth`, 301);
  }

  return Astro.redirect("/not-found");
}
---

<BaseLayout
  pageTitle="YouTube Income Estimator â€“ Check How Much Money Any Channel Makes"
  pageDescription="Estimate how much money any YouTube channel makes from ads. Just enter a channel name or handle to see monthly and yearly income. Fast, free, and accurate."
  pageUrl="https://youtubersincome.com"
  pageImage="/og-default.webp"
  showLoader={true}
>
  <Header client:load />
  <main class="min-h-screen bg-background">
    <Hero />
    <RecentChannels />
    <HighestEarningChannels />
    <BlogPreview />
    <HowItWorks />
    <Faq client:load />
    <About />
  </main>
  <Footer />
</BaseLayout>
