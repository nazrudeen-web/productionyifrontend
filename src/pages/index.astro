---
import "../styles/global.css";
import BaseLayout from "../layout/BaseLayout.astro";
import Header from "../components/Header.astro";
import Hero from "../components/Hero.astro";
import FakeRecentChannels from "../components/FakeRecentChannels.astro";
import TopChannels from "../components/TopChannels.astro";
import Footer from "../components/Footer.astro";
import HowItWorks from "../components/HowItWorks.astro";
import Faq from "../components/Faq.astro";
import About from "../components/About.astro";
import BlogPreview from "../components/BlogPreview.astro";

// Get "channel" input from URL (example: ?channel=MrBeast or ?channel=@mrbeast)
const url = new URL(Astro.request.url);
const pathname = url.pathname;

// Only run redirect logic if user is on homepage AND ?channel exists
const input = pathname === "/" ? url.searchParams.get("channel") : null;

// Clean user input: remove @ or get path from full URL
function cleanInput(raw) {
  const trimmed = raw.trim();
  if (trimmed.startsWith("http")) {
    try {
      const link = new URL(trimmed);
      return link.pathname.replace(/^\/+/, "");
    } catch {
      return trimmed;
    }
  }
  return trimmed.replace(/^@+/, "");
}

// Check if input is YouTube channel ID (starts with UC...) or handle/name
function detectInputType(value) {
  return /^UC[a-zA-Z0-9_-]{22}$/.test(value) ? "id" : "handleOrName";
}

// If input exists, process it and redirect to proper page
if (input) {
  const cleaned = cleanInput(input);
  const apiUrl = `https://api.youtubersincome.com/?channel=${encodeURIComponent(cleaned)}`;
  const res = await fetch(apiUrl);
  const data = await res.json();

  if (res.ok && (data.handle || data.title)) {
    const baseName = data.handle
      ? data.handle.replace(/^@+/, "")
      : data.title.toLowerCase().replace(/\s+/g, "");
    return Astro.redirect(`/${baseName}-net-worth`, 301);
  }

  return Astro.redirect("/not-found");
}
---

<BaseLayout
  pageTitle="YouTube Income Estimator â€“ Check How Much Money Any Channel Makes"
  pageDescription="Estimate how much money any YouTube channel makes from ads. Just enter a channel name or handle to see monthly and yearly income. Fast, free, and accurate."
  pageUrl="https://youtubersincome.com"
>
  <Header />
  <Hero />
  <FakeRecentChannels />
  <TopChannels />
  <BlogPreview />
  <HowItWorks />
  <Faq />
  <About />
  <Footer />
</BaseLayout>
